#~Z_CALIBRATION~
##To-Do##
# 1. make sure the nozzle and the omron body (not the switch!!) reach the bolthead (See images on Discord)
# 2. Make a backup of your cfg
# 3. Read Protolofts Readme about the script implementation to install it and understand how it works
# 4. Remove z_offset commands from the start gcode and saved values at the bottom of your config (probe and/or endstop)
# 5. Decrease all homig and probing speeds for the first test so you have time to react!

########################
##z_calibrate settings##
########################

[z_calibration]
nozzle_xy_position: 185,235.5 #NOZZLE XY POSITION FOR TOUCHING THE SEXBOLT
########################
#   A X, Y coordinate (e.g. 100,100) of the nozzle, clicking on the Z endstop.

switch_xy_position: 177,202 #PROBE XY POSITION FOR TOUCHING THE SEXBOLT. MAKE SURE TO ONLY TOUCH THE SEXBOLT WITH THE BLACK PROBE BODY NOT THE BUTTON ITSELF
#   A X, Y coordinate (e.g. 100,100) of the probe's switch body, clicking on
#   the Z endstop.

bed_xy_position: 112.5,112.5
#   a X, Y coordinate (e.g. 100,100) where the print surface (e.g. the center
#   point) is probed. These coordinates will be adapted by the
#   probe's X and Y offsets. The default is the relative_reference_index
#   of the configured bed_mesh, if configured. It's possible to change the relative
#   reference index at runtime or use the GCode argument BED_POSITION of CALIBRATE_Z.

switch_offset: 0.619 #Omron is 0.5!!!
###################
#   The trigger point offset of the used mag-probe switch.
#   Larger values will position the nozzle closer to the bed.
#   This needs to be find out manually. More on this later
#   in this section..

max_deviation: 1.0   
#   The maximum allowed deviation of the calculated offset.
#   If the offset exceeds this value, it will stop!
#   The default is 1.0 mm.
samples: 4
#   The number of times to probe each point. The probed z-values
#   will be averaged. The default is from the probe's configuration.
#samples_tolerance: default from "probe:samples_tolerance" section
#   The maximum Z distance (in mm) that a sample may differ from other
#   samples. The default is from the probe's configuration.
#samples_tolerance_retries: default from "probe:samples_tolerance_retries" section
#   The number of times to retry if a sample is found that exceeds
#   samples_tolerance. The default is from the probe's configuration.
samples_result: median
#   The calculation method when sampling more than once - either
#   "median" or "average". The default is from the probe's configuration.
clearance: 20
#   The distance in mm to move up before moving to the next
#   position. The default is two times the z_offset from the probe's
#   configuration.
#position_min: default from "stepper_z:position_min" section.
#   Minimum valid distance (in mm) used for probing move. The
#   default is from the Z rail configuration.
speed: 100
#   The moving speed in X and Y. The default is 50 mm/s.
#lift_speed: default from "probe:lift_speed" section
#   Speed (in mm/s) of the Z axis when lifting the probe between
#   samples and clearance moves. The default is from the probe's
#   configuration.
#probing_speed: default from "stepper_z:homing_speed" section.
#   The fast probing speed (in mm/s) used, when probing_first_fast
#   is activated. The default is from the Z rail configuration.
probing_second_speed: 5 # default from "stepper_z:second_homing_speed" section.
#   The slower speed (in mm/s) for probing the recorded samples.
#   The default is second_homing_speed of the Z rail configuration.
probing_retract_dist: 2.5 #default from "stepper_z:homing_retract_dist" section.
#   Distance to retract (in mm) before probing the next sample.
#   The default is homing_retract_dist from the Z rail configuration.
#probing_first_fast: false
#   If true, the first probing is done faster by the probing speed.
#   This is to get faster down and the result is not recorded as a
#   probing sample. The default is false.
start_gcode: NOZZLE_BRUSH #THIS CALLS THE NOZZLE_BRUSH MACRO IF USING MINE, OTHERWISE ENTER YOUR BRUSH MACRO OR COMMENT OUT
#   A list of G-Code commands to execute prior to each calibration command.
#   See docs/Command_Templates.md for G-Code format. This can be used to
#   attach the probe.
before_switch_gcode: _PROBE_OUT #change this TO AVOID AN EXTRA TRAVEL. USED ONLY FOR CALIBRATE_Z
##############################
#   A list of G-Code commands to execute prior to each probing on the
#   mag-probe. See docs/Command_Templates.md for G-Code format. This can be
#   used to attach the probe after probing on the nozzle and before probing
#   on the mag-probe.
end_gcode: PROBE_IN #change this if your macros are named differently than from Klack config
###################
#   A list of G-Code commands to execute after each calibration command.
#   See docs/Command_Templates.md for G-Code format. This can be used to
#   detach the probe afterwards.

[homing_override]
set_position_z:0 # Make printer think Z axis is at zero, so we can force a move upwards away from build plate
gcode:
    G90
    G1 Z10 F3000 ; move up to prevent accidentally scratching build plate    
    G28 X
    G28 Y
    G1 X185 Y235.5 F6000 #THE POSITION IN X,Y OF YOUR NOZZLE OVER THE SEXBOLT
    G28 Z #Z WILL NOW HOME ON THE SEXBOLT VIA THE NOZZLE
    G1 Z15 F3000
    G1 X0 Y0 F6000
    
[gcode_macro _PROBE_OUT] #USE THIS TO REPLACE PROBE_OUT MACRO ONLY IN Z_CALIBRATION CONFIG
gcode:
    G90
    G1 X244 F4000 #X LOCATION TO PICK UP PROBE
    G4 P300
    G1 Z20
    G1 X177 #X LOCATION OF PROBE BODY, USE X COORDINATE FROM SWITCH_XY_POSITION IN Z_CALIBRATION

[gcode_macro NOZZLE_BRUSH]
gcode:
    G90

    # Clear approach
    G1 Z16 F3000
    G1 X30 Y236.5 F6000

    # --- Scrub line 1 (two passes, left -> right) ---
    G1 Z1 F3000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000

    # --- Scrub line 2 (two passes, left -> right) ---
    G1 Y239.5 F6000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000

    # --- Finish passes (between lines, higher Z) ---
    G1 Z2 F3000
    G1 Y238.0 F6000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    G1 X30 F10000
    G1 X80 F10000
    
    # Clear brush
    G1 Z20 F3000

; ============================================================
; START_PRINT MACRO
; Purpose: Prepare printer for a new print
; Notes:
;  - Do NOT change values unless you know what you are doing
;  - Uses adaptive bed mesh and Z calibration
; ============================================================

#~START_PRINT~
[gcode_macro START_PRINT]

gcode:

    ; ----------------------------
    ; Reset & Parameter Setup
    ; ----------------------------
    G92 E0                         ; Reset extruder position

    {% set BED = params.BED|default(75)|float %}
    {% set EXTRUDER = params.EXTRUDER|default(235)|float %}

    ; ----------------------------
    ; Heat Bed & Home
    ; ----------------------------
    M140 S{BED}               ; Start heating bed
    G28                            ; Home all axes
    M190 S{BED}               ; Wait for bed to reach target temp

    ; ----------------------------
    ; Heat Extruder
    ; ----------------------------
    M104 S{EXTRUDER}         ; Start heating extruder (do not wait)

    ; ----------------------------
    ; Probing & Mesh
    ; ----------------------------
    BED_MESH_CLEAR
	BED_MESH_CALIBRATE ADAPTIVE=1
    G1 Y0 F4000                   ; Move bed forward

    ; ----------------------------
    ; Z Calibration
    ; Bed and nozzle should be fully heated
    ; If using a brush, nozzle should be at temp
    ; Otherwise, minimum 180Â°C
    ; ----------------------------
    M109 S{EXTRUDER}
    G1 E-2 F1800 #2mm retract to combat ooze
    G4 S120 # wait two minutes to hopefully finish oozing
    CALIBRATE_Z
    
    # Adjust the G-Code z-offset if needed
    SET_GCODE_OFFSET Z_ADJUST={params.Z_ADJUST|default(0.0)|float} MOVE=1
    ; ----------------------------
    ; Move to Prime Position
    ; ----------------------------
    #G1 E0 F600
    #G1 Z2.0 F3000                  ; Lift nozzle to avoid scratching bed
    #G1 X1.1 Y20 Z0.3 F4000.0   ; Move to prime start position
    Smart_Park
    ; ----------------------------
    ; Final Extruder Heat
    ; ----------------------------
    M109 S{EXTRUDER}          ; Wait for extruder to reach target temp

    ; ----------------------------
    ; Prime Lines
    ; ----------------------------
    #G1 X1.1 Y200.0 Z0.3 F1500.0 E15 ; Draw first prime line
    #G1 X1.6 Y200.0 Z0.3 F4000.0    ; Shift nozzle slightly
    #G1 X1.6 Y20 Z0.3 F1500.0 E30   ; Draw second prime line
    LINE_PURGE
    ; ----------------------------
    ; Final Reset & Clear Area
    ; ----------------------------
    G92 E0                         ; Reset extruder again
    G1 Z3.0 F3000                  ; Lift nozzle
    G1 X5 Y20 Z0.3 F4000.0         ; Move aside to prevent blob squish

##############################
# END PRINT MACRO
##############################

[gcode_macro END_PRINT]
gcode:
    # Read current and max Z from Klipper
    {% set cur_z = printer.toolhead.position.z %}
    {% set max_z = printer.toolhead.axis_maximum.z %}

    # Lift Z by 2 mm but never exceed max Z
    {% set lift1 = cur_z + 20 if (cur_z + 20) < max_z else max_z %}
    G1 Z{lift1} F600

## BRUSH TIME
    M109 S235
    G1 E-2 F1800 #2mm retract to combat ooze
    G4 S120 # wait two minutes to hopefully finish oozing
    G1 X30 Y236.5 F6000
    NOZZLE_BRUSH
    NOZZLE_BRUSH

    # Lift further by +70 mm but stay within limits
    {% set lift2 = cur_z + 70 if (cur_z + 70) < max_z else (max_z - 25) %}
    G1 Z{lift2} F600

    # Lift to 70% of Z-height if print was very short
    {% set lift3 = max_z * 0.7 %}
    {% if cur_z < lift3 %}
        G1 Z{lift3} F600
    {% endif %}

    # Move toolhead to presentation position
    G1 X5 Y{printer.toolhead.axis_maximum.y * 0.8} F6000

    # --- HOT RETRACT TO PREVENT OOZING ---
    #{% if printer.extruder.temperature > 160 %}
    #    M83                     ; Relative extrusion
    #    G1 E-2.0 F1800          ; Hot retract 2mm
    #    M82                     ; Restore absolute extrusion
    #{% endif %}

    # Cooling wait
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=50
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM=40

    # Turn off heaters and fans
    M104 S0
    M140 S0
    M107

    # Disable motors
    M84 X Y E